name: Frontend Dev CD (Docker + ECR + ASG)

on:
  push:
    branches: [develop]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
      - 'context/**'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-2
  ECR_REPOSITORY: billage-fe
  ASG_NAME: billage-dev-v2-fe-asg

# ============================================================
# Î∞∞Ìè¨ ÌùêÎ¶Ñ:
# 1. Docker ÎπåÎìú ‚Üí ECRÏóê Ïù¥ÎØ∏ÏßÄ Push
#    - NEXT_PUBLIC_*Îäî ÎπåÎìú ÏãúÏ†êÏóê JS Î≤àÎì§Ïóê Ìè¨Ìï®
# 2. ASG Instance Refresh Ìä∏Î¶¨Í±∞
# 3. ASGÍ∞Ä ÏÉà EC2 Î∂ÄÌåÖ ‚Üí user_data Ïã§Ìñâ
#    - ECRÏóêÏÑú billage-fe:latest Pull
#    - SSM /billage/dev/fe/* ÏóêÏÑú ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú ÌôòÍ≤ΩÎ≥ÄÏàò Ï°∞Ìöå
#    - docker run -e Î°ú ÏÑúÎ≤ÑÏÇ¨Ïù¥Îìú ÌôòÍ≤ΩÎ≥ÄÏàò Ï£ºÏûÖ
# 4. ALB Health Check (/) ÌÜµÍ≥º ‚Üí Í∏∞Ï°¥ EC2 Ï¢ÖÎ£å
# ============================================================

jobs:
  # ============================================================
  # Job 1: Docker ÎπåÎìú & ECR Push
  # ============================================================
  build-and-push:
    name: Build & Push to ECR
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-latest
            ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ secrets.DEV_NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_IMAGE_HOSTNAME=${{ secrets.DEV_NEXT_PUBLIC_IMAGE_HOSTNAME }}
            NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_API_KEY }}
            NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}
            NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_PROJECT_ID }}
            NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}
            NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}
            NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_APP_ID }}
            NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID }}
            NEXT_PUBLIC_FIREBASE_VAPID_KEY=${{ secrets.DEV_NEXT_PUBLIC_FIREBASE_VAPID_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=min
          provenance: false

      - name: Output Image Info
        run: |
          echo "‚úÖ Pushed: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:latest"
          echo "‚úÖ Pushed: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-latest"
          echo "‚úÖ Pushed: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}"
      - name: Trigger ECR Scan
        continue-on-error: true
        run: |
          aws ecr start-image-scan \
            --repository-name ${{ env.ECR_REPOSITORY }} \
            --image-id imageTag=${{ github.sha }}
  # ============================================================
  # Job 2: ASG Instance Refresh (Dev Î∞∞Ìè¨)
  # ============================================================
  deploy:
    name: Deploy to Dev (Instance Refresh)
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Discord - Deploy Started
        run: |
          curl -H "Content-Type: application/json" -X POST \
            -d '{"embeds": [{"title": "üöÄ [DEV] Frontend Î∞∞Ìè¨ ÏãúÏûë", "color": 3447003, "fields": [{"name": "Commit", "value": "`${{ github.sha }}`", "inline": true}]}]}' \
            ${{ secrets.DISCORD_WEBHOOK }} || true
      # MinHealthyPercentage: 0 ‚Üí DevÎäî Ïù∏Ïä§ÌÑ¥Ïä§ 1ÎåÄÎùºÏÑú Í∏∞Ï°¥ Ï¢ÖÎ£å ÌõÑ ÏÉàÎ°ú ÎùÑÏõÄ (Îã§Ïö¥ÌÉÄÏûÑ Î∞úÏÉù)
      - name: Trigger ASG Instance Refresh
        id: refresh
        run: |
          REFRESH_ID=$(aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${{ env.ASG_NAME }} \
            --strategy Rolling \
            --preferences '{"MinHealthyPercentage": 0}' \
            --query "InstanceRefreshId" \
            --output text)
          echo "refresh_id=${REFRESH_ID}" >> $GITHUB_OUTPUT
          echo "üîÑ Instance Refresh Started: ${REFRESH_ID}"
      - name: Wait for Instance Refresh
        timeout-minutes: 10
        run: |
          REFRESH_ID="${{ steps.refresh.outputs.refresh_id }}"
          while true; do
            STATUS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ env.ASG_NAME }} \
              --instance-refresh-ids ${REFRESH_ID} \
              --query "InstanceRefreshes[0].Status" \
              --output text)
            PROGRESS=$(aws autoscaling describe-instance-refreshes \
              --auto-scaling-group-name ${{ env.ASG_NAME }} \
              --instance-refresh-ids ${REFRESH_ID} \
              --query "InstanceRefreshes[0].PercentageComplete" \
              --output text)
            echo "üìä Status: ${STATUS}, Progress: ${PROGRESS}%"
            case $STATUS in
              "Successful")
                echo "‚úÖ Instance Refresh completed successfully!"
                exit 0
                ;;
              "Failed"|"Cancelled"|"RollbackSuccessful"|"RollbackFailed")
                echo "‚ùå Instance Refresh failed with status: ${STATUS}"
                exit 1
                ;;
              *)
                sleep 30
                ;;
            esac
          done
      - name: Discord - Deploy Success
        if: success()
        run: |
          curl -H "Content-Type: application/json" -X POST \
            -d '{"embeds": [{"title": "‚úÖ [DEV] Frontend Î∞∞Ìè¨ ÏôÑÎ£å", "color": 65280, "fields": [{"name": "Commit", "value": "`${{ github.sha }}`", "inline": true}, {"name": "ASG", "value": "`${{ env.ASG_NAME }}`", "inline": true}]}]}' \
            ${{ secrets.DISCORD_WEBHOOK }} || true
      - name: Discord - Deploy Failure
        if: failure()
        run: |
          curl -H "Content-Type: application/json" -X POST \
            -d '{"content": "@here", "embeds": [{"title": "‚ùå [DEV] Frontend Î∞∞Ìè¨ Ïã§Ìå®", "color": 16711680, "fields": [{"name": "Commit", "value": "`${{ github.sha }}`", "inline": true}, {"name": "Refresh ID", "value": "`${{ steps.refresh.outputs.refresh_id }}`", "inline": true}]}]}' \
            ${{ secrets.DISCORD_WEBHOOK }} || true
      - name: Cancel Instance Refresh on Failure
        if: failure()
        continue-on-error: true
        run: |
          aws autoscaling cancel-instance-refresh \
            --auto-scaling-group-name ${{ env.ASG_NAME }} || true
          echo "üîô Instance Refresh cancelled"