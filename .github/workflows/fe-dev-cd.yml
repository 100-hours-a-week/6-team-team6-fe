name: Frontend Dev CD

on:
  workflow_run:
    workflows: ["Frontend CI"]
    types: [completed]
    branches: [develop]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Download CI Artifacts
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: ${{ github.event.workflow_run.workflow_id }}
          run_id: ${{ github.event.workflow_run.id }}
          name: frontend-build
          path: ./frontend-build

      
      # artifacts를 압축해서 서버로 전송합니다.
      - name: Upload to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          source: "frontend-build/**/*"
          target: "/home/ubuntu/deploy_temp"
          strip_components: 1 # frontend-build 폴더 껍데기 벗기기

     
      # 서버에 접속해서 압축 풀고 재시작
      - name: Deploy & Restart
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEV_EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.DEV_EC2_SSH_KEY }}
          script: |
            # 1. 배포 경로 준비
            sudo mkdir -p /opt/billage/frontend
            sudo chown ubuntu:ubuntu /opt/billage/frontend
            
            # 2. 기존 파일 정리 (선택: 깔끔하게 지우고 시작)
            rm -rf /opt/billage/frontend/*
            
            # 3. 파일 이동 (Standalone 빌드 기준)
            # 주의: CI에서 업로드한 구조에 따라 경로가 다를 수 있습니다.
            # 아래는 .next 통째로 받았을 때의 예시입니다.
            cp -r /home/ubuntu/deploy_temp/* /opt/billage/frontend/
            
            # 4. 임시 파일 삭제
            rm -rf /home/ubuntu/deploy_temp
            
            # 5. 서비스 재시작
            sudo systemctl restart billage-frontend
            
            # 6. 확인
            sleep 2
            systemctl status billage-frontend --no-pager
